#!/bin/bash
# Ghostty統合起動スクリプト (3ペインレイアウト)

set -e

PROJECT_DIR="${1:-$PWD}"

if [ ! -d "$PROJECT_DIR" ]; then
    echo "エラー: ディレクトリが存在しません: $PROJECT_DIR"
    exit 1
fi

# プロジェクトディレクトリを絶対パスに変換
PROJECT_DIR=$(cd "$PROJECT_DIR" && pwd)

echo "プロジェクト: $PROJECT_DIR"

# ホットリロード機能を起動（バックグラウンド）
if ! pgrep -f "ghostty-vim-hotreload" > /dev/null; then
    nohup ghostty-vim-hotreload > /tmp/ghostty-vim-hotreload.log 2>&1 &
    echo "✓ ホットリロード機能を起動"
fi

# Ghosttyで3ペインレイアウトを構築
# レイアウト: 左30% (filetree上60%, keifu下40%), 右70% (Claude Code)

osascript << EOF
tell application "Ghostty"
    activate
end tell

delay 0.5

tell application "System Events"
    -- 最初のペイン: filetree (左上)
    keystroke "ghostty-pane-filetree '$PROJECT_DIR'"
    keystroke return
    delay 1.5

    -- 下にスプリット: keifu (左下)
    keystroke "d" using {command down, shift down}
    delay 0.5
    keystroke "ghostty-pane-keifu '$PROJECT_DIR'"
    keystroke return
    delay 1.5

    -- 左上のfiletreeペインに移動
    keystroke "k" using {command down, control down}
    delay 0.3

    -- 右にスプリット: Claude Code (右側)
    keystroke "d" using command down
    delay 0.5
    keystroke "ghostty-pane-claude '$PROJECT_DIR'"
    keystroke return
    delay 0.5
end tell
EOF

echo "✓ レイアウト構築完了"
echo ""
echo "キーバインド:"
echo "  Ctrl+Cmd+H/J/K/L  - ペイン間移動"
echo "  Cmd+W             - ペイン閉じる"
echo "  Ctrl+Cmd+E        - ペイン均等化"
echo ""
echo "ペイン構成:"
echo "  左上: filetree (ファイルエクスプローラー)"
echo "  左下: keifu (Git履歴)"
echo "  右側: Claude Code (AI支援)"
